
# LFR

Path treaversal (Directory Traversal) - веб уязвимость, которая пощзволяет атакующему читать произвольные файлы на системе

Пример:

https\://example.com/load_image...

заголовок Content-Disposition: attachment -> файлик не отображается в браузере, а скачивается

LFR. Proof of Concept (PoC) - стандартное доказательство существования уязвимости

Linux: /etc/passwd -> всегда существует файл, хранятся логины пользователей
Windows: \windows\win.ini -> системные данные

### LFR. Цели атакующего
- Исходный код приложений
- Файлы с паролями/уз
- Чувствительные файлы ос
- Запись файлов -> RCE

### Чувствительные файлы ОС:

- Информация об ОС ...
- Сеть ...
- Процессы ...
- Текущий путь ...
- Индексирование ...
- Пароли и история ...
- Kubernetes ...

# LFI

позволяет загрузить и исполнить файл с операционной системы. В данном случае, если на системе будет файл с вредоносной нагрузкой (php-shell), мы получим исполнение кода. Особенно опасно на PHP

### Получение RCE через LFI

- Загрузка и вызов шелла (очевидно)
- Mail-log системы
	- Отправляется письмо к внутреннему пользователю
	- Происходит LFI к mail-логу
- Сессии PHP
	- Регистрация пользователя, содержащего нагрузку в поле объекта (например, имени)
	- Происходит LFI к хранилищу сессий
- Access-лог веб-сервера
	- Нагрузка помезяется в User-Agent или параметр Get-запроса
	- Происходит LFI к лог файлу
- Аналогичная техника с логами ssh

### Наиболее популярные параметры для LFR / LFI / RFI

...

### Обход защиты

- Использование абсолютного пути
- Использование кодировок
- Использование нулевого байта
- Нерекурсивное удаление
- Проверка начала пути
- Разногласия парсинга
- Path Truncation - в некоторых ЯП длинные имена файлов обрезаются
- (RFI, Windows) Обход блокировки с использованием smb share
- Использование фильтров PHP

### Использование различных протоколов
- Java URL
- data:// (RCE в случае RFI)
- zip:// и rar:// (нужен соответствующий шелл)
- php://filter (RCE possible)
- php://fd (чтение)
- expect:// (RCE; вживую почти никогда не увидите)
- php://imput - payload передаётся в теле POST
- phar:// - десериализация
- ...

### Защита
- Не использовать пользовательский ввод в API ОС
- Валидация пользовательского  ввода
- Добавлять префикс пути, канонизировать путь, после чего сравнивать начало с ожидаемым префиксом

# XXE (XML eXternal Entity)

-это веб уязвимость, которая позволяет злоумышленнику вмешиваться в процесс обработки XML данных приложения

XML - формат передачи данных

DTD Document Type Definition

- секция XML документа, определяющая стректуру докуемнта, типы данных и прочую информацию
- Вводится ключевым словом DOCTYPE
- ...

XML Entities

XML - сущность - это структура данных, обычно содержащая корректный XML-код
...

XML Internal Entities
- Определяются локально внутри DTD
- Часто используются как замена посторяющихся строк 
- Обращение через `&param;`

XML External Entities
- Определены не локально, т.е. на внешнем ресурсе или ином файле
- Бывают приватными и публичными
- В теле XML на них можно ссылаться аналогично внутренним сущностям

Эксплуатация XXE происходит через внешние сущности

XML Parameter entities
- Существуют строго внутри DTD
- Имеют слегка отличающийся синтаксис при ссылке

Unparsed External Entities
- XML Entity не обязана содержать валидный XML-синтаксис
- В некоторых обработчиках XML исеется возможность явно указать на отсутствие необходимости обрабатывать данные при помощи NDATA (TYPE - тип данных)
- Таким образом можно получить доступ к бинарному контенту

Примеры XXE атак:
...

Пример в исходном коде:
...

Возможное влияние:
- Чтение файлос ОС
- SSRF
- DoS
- RCE

Разновидности:
- Видимые: результат эксплуатации виден в ответах приложения
- Слепые: результат эксплуатации не виден в ответах приложения
- Экзотические

SSRF via XXE

как проследить результат слепой XXE: отправить запрос на какой-то сервер, к которому есть доступ

Возможнн ли листинг директории через XXE? - Нет, нужно чётко знать нужный файл. НО! Если у нас java, то обработчик file:// выводит листинг, если на вход передана директория

Слепые XXE: детектирование и эксплуатация
- Обнаружение SSRF на подконтрольный сервер (HTTP, DNS, FRP, иные протоколы)
- Эксплуатация:
	- Вывод данных на внешний сервер
	- Вывод данных через сообщения об ошибках
	- Вывод данных через переопределение локального DTD

Слепые XXE: вывод данных на внешний сервер
1. Атакующий создаёт на своём сервере dtd-файл с XML-сущностями. Задача данного файла - прочитать файл и передать содержимое на сервер атакующего
2. Уязвимому приложению подаётся на вход внешняя сущность, выполняющая обращение к внешнему dtd на сервере атакующего

Какая проблема может быть и почему? - выведется одна строка и всё

Слепая XXE через сообщения об ошибках: 
принцип тот же, просто в конце мы не отправялем данные на сервер, а триггерим ошибку

Чтение файлов: возможная проблема
Invalid product name...

Что не так и почему? 

Ранее обозначенные проблемы и пути их решения:
1. При отрпавке финального запроса на внешний сервер может быть отправлена часть данных. Это может происходить из-за нестандартного типа данных или содержания в нем спец символов. Решение: использовать другой протокол, использовать фильтры php или использовать CDATA
2. При чтении файла с ОС может выводиться одна строка. Это может происходить из-за того, что XML-обработчик встретил символ переноса строки и воспринял его как конец файла...

CDATA and php filters
1. Можно использовать филттры php для преобразования данных в другой формат
2. Можно обернуть вывод в CDATA при помощи parameter entities (использовать CDATA вне DTD ни один нормальный обработчик не позволит)
...

Почему нельзя использовать только Internal DTD для использования CDATA и эксфильтрации данных? - Использование parameter entity для определения другой parameter entity разрешено спецификацией, но запрещено ...

Есть обход.
Слепые XXE: вывод данных через переопределение локального DTD
- Может быть использовано, если невозможно обратиться к внешнему DTD на сервере атакующего
- Необходимо, чтобы на сервере был внешний DTD, определённый разработчиками. Также, необходимо знать (получить) как минимум одну определённую сущность. Получить его можно попыткой указания пути в качестве внешней сущности или при помощи другой уязвимости, позволяющей читать файлы ОС
- Смысл техники заключается в переопределении сущности в локально расположенном DTD. В данном случае будет возможно использование parameter entity для определения другой parameter entity (для XML эта сущность будет считаться причастной к внешнему DTD)

Экзотические XXE
- Xinclude (способ сборки XML-документов из частей)
- Загрузка SVG (подобным образом можно использовать любые XML-valid файлы, например, docx, xlsx и пр)
- SOAP-запросы (формат построения POST запроса)
- Изменение content-Type Post-запроса на text/xml (чаще всего может сработать, если исходный запрос был в json)

DoS vis XXE
- Billion Laugh attack
- YAML attack (то же самое)
- Parameters Laugh Attack

RCE в XXE
Аналогично RCE в SSRF
- Использование фильтров php
- Использование expect://
- Использование протокола gopher://

Защита:
- Отключение возможности разрешения внешних сущностей XML-обработчиком (в некоторых популярных библиотеки, для GO внешние сущности отключены по умолчанию)
- Отключить XInclude
- Использовать корректную обработку для конкретных типов данных (для экзотических XXE)











