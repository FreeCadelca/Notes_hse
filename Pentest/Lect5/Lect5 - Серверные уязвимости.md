### Основные понятия

> Идентификация -  процедура, в результате выполнения которой для субъекта инентификации выявляется его идентификатор, однозначно определяющий этого субъекта в инф системе

> Аутентификация - процедура проверки подлинности (лог + пароль)

> Авторизация - предоставление определенному лицу или группе лиц его прав

Пример:
идентификация - предъявление паспортра
аутентификация - проверка наличия билета
авторизация - возможность занять свое место

Ввод логина - идентификация
Аутентификация - проверка пароля+логина
Авторизация - вход в аккаунт

Сессии и JWT


| Критерий                    | Сессии                                           | Json Web Tokens                                          |
| --------------------------- | ------------------------------------------------ | -------------------------------------------------------- |
| Место хранения состояния    | Серверная память или хранилище (БД)              | Клиентская сторона (local storage)                       |
| Масштабируемость            | Требует синхронизации сессий между серверами     | Stateless                                                |
| Производительность          | Запросы к хранилищу для проверки сессии          | Быстрая проверка подписи токена без запросов к БД        |
| Межсерверное взаимодействие | Сложно использовать в микросервисной архитектуре | Идеально для микросервисов                               |
| Отзыв                       | Легко отозвать через сервер (удаление сессии)    | Сложнее отозвать (требуются черные списки, короткие TTL) |

### Атаки на аутентификацию

Аутентификация имеет разные количества и типы факторов

1. Знание (Knowlege) - что-то, что ты знаешь (пароль, ответ на секретный вопрос)
2. Владение (Possession) - что-то, чем ты владеешь (телефон, физ токен)
3. Свойство (ingerence) - что-то, что является частью тебя (биометрия, характер поведения)

Возможное влияние:
- захват аккаунта (Account Takeover, ATO)
- Кража ПД
- Повышение привилегий
- Повышение шансов на RCE

##### Password-based login: методы и атаки 
1. Использование слабых паролей и паролей по умолчанию
<картинка>
	Защита: 
	- проверка сложности пароля, 
	- смена паролей по умолчанию
	- ставить проверку на предыдущие 5 паролей
	- проверять список слитых паролей
2. Credential Stuffing - переиспользование пар логин-пароль
3. Username Enumeratiion - возможность определить существование пользователя, исходя из
	- Различных текстов ответа приложения
	- Различных кодов ответа
	- Незначительных опечаток в одинаковых ответах приложения
	- Разного времени ответа приложения
	Защита:
	- Возвращение одинакового ответа вне зависимости от существования пользователя в системе
4. Брутфорс
	Методы защиты:
	- Блокировка по ip 
		- (обход - сброс счетчика путем входа в валидный акк, маскировка настоящего ip; использование распределенной системы перебора)
	- Блокировка учетной записи 
		- (Обход - создает возможность User Enumeration; делает возможным множественную блокировку УЗ)
	- CAPTCHA 
		- (Обход - эксплуатация мисконфигураций капча, модификация, переиспользование, игнорирование и пр.)
5. Умный перебор - эксплуатация особенностей языков программирования и технологий, используемых в приложении
	Примеры:
	- В некоторых случаях мы можем отправить не один пароль, а массив паролей, кадждый из которых будет проверять приложением
	- В GraphQL существуют алиасы, с помощью которых можно перебрать несколько значений одним запросом
6. Перебор в базовой аутентификации (Basic authentication)
	`Authorization: Basic DOjSvCW4=` -> base64 decode -> admin:admin
	Защита: отказаться от базовой аутентификации
7. Client-side aythentication
	Нужно отказываться от такого!

Мультифакторная авторизация: методы атаки
1. Слабый генератор OTP (one-time password)
	Слабый генератор
	```
	seed = 123123
	rand(seed) = a1
	rand(seed) = a1
	```
	Более надежный генератор
	```
	seed = 123123
	rand(seed) = a1
	rand(seed) = b2
	```
	Защита:
	- Использование надежных приложений (Google Auth) и функций для генерации OTP
2. Некорректное состояние сессии:
	Гость -> пройден 1 фактор -> пройденны оба фактора
3. Account hijack
	https\://example.com/2nd-stage?==id=2==
	Защита:
	- Привязка OTP к идентификатору
	- ...
4. Перебор OTP
	Защита:
	- Инвалидация временной сессии 
		- Обход - автоматизация прохождения первого фактора)
	- Инвалидация OTP после N неверных попыток
		- Запрос нового кода и перебор N первых кодов (вероятностный поход)
5. Flood
	Защита: Лимит на отправку OTP, потом таймаут

Прочие механизмы аутентификации:
Кастомная аутентификационная cookie
1. Cookie guessing - подмена/угадывание/подбор
2. Insecure deserialization

Прочие механизмы аутентификации
Восстановление пароля
1. Token guessing - слабая энтропия (нерандомный рандом) или логические ошибки
2. SQLi Ultimate Power - легкий ATO через SQLi (Почему? - Если есть функционал восстановления - значит есть токен => через sqli вытаскиваем токен в чистом виде, они редко защищены)
3. Host Header attacks
4. Exotic exploits (e.g. dangling markup injection)
5. User enum
6. Flood

Смена пароля
1. Broken access control (смена пароля другому пользователю)
2. Logic Flaws (перебор пароля без блокировки УЗ)
3. Prototype Pollution (Server-Side)
4. Mass Assignment (мы можем при смене добавить смену роли, а также других полей)

Прочие механизмы аутентификации:
Кастомная CAPTCHA
1. CAPTCHA guessing (угадывание капчи)
2. CAPTCHA modify (замена значения на необходимое)
3. CAPTCHA reuse (переиспользование)
4. CAPTCHA DoS (возможность испортить единичную капчу или группу ...)

Регистрация
1. ...


### Сессии

Сессия - это механизм, который позволяет серверу сохранять информацию о взаимодействии с конкретным пользователем в течение определенного периода времен (пока пользователь активен на сайте)

Проще говоря, это способ "помнить" пользователя

На стороне сервера сессии присваиваются состояния

Sessioon Fixation - позволяет злоумышленнику перехватить действующий сеанс управления идентификатором сеанса веб-приложения.
- Атакующий может получить id сессии и отправить жертве. После того, как жертва аутентифицируется в системе, атакующий получит валидную сессию жертвы

Атака реализуется, если
1. Приложение не выдает нового id сессии после успешной аутентификации пользователя
2. Атакующий может выставить жертве id сессии (через client-side уязу или иными способами)
Защиты: выдача нового SessId после аутентификации

Session Puzzling - уяза, которая возникает, когда переменная сеанса приложения используется для более одного назначения
- В результате эксплуатации атакующий получает доступ к свойтсвам сессии другого пользователя
Защита: использовать переменную сеанса только для одного назначения

Imposter Session Invalidation
- После выхода из аккаунта сессия остается валидной
- Если сессия будет украдена, то нет способа сделать ее невалидной кроме прямого вмешательства
Защита: корректная инвалидация сессии после выхода из аккаунта или по истечении времени

### Json Web Tokens (JWT)

-стандартизированный формат для передачи криптографически подписанных данных json между системами. Теоретически они могут содержать любые данные, но чаще всего используются для передачи информации "claims" о пользовательских...

Структура
1. Заголовок
2. Тело
3. Криптографические свойства

JWT vs JWS vs JWE

JWS (Json Web Signature)
- Стандарт подписи JWT при помощи секретного ключа
- Обычно имеют в виду именно это, когда говорят о jwt

JWE (Json Web Encryption)
- Стандарт шифрования Payload-части
- Обычно имеет формат...

Симметричные и ассиметричные алгоритмы подписи
- Симметричный (HS256 - HMAC+SHA256) - один ключ используется и для подписи, и для проверки подписи
- Ассиметричный (RS256 - RSA+SHA256) - закрытый ключ используется для подписи, открытый - для проверки подписи

Access и Refresh токены
- Способ управления "долгосрочной" авторизацией пользователя
- В UI обычно будет применён после нажатия кнопки "запомнить меня"
- Идея: при аутентификации выдаётся два токена: Access и Refresh
- Токены помещаются в разные места и имеют разный срок жизни
- Access Token имеет имеет короткий срок жизни и используется для авторизации
- Refresh Token имеет долгий срок жизни и используется для получения новой пары Access и Refresh-токенов
- Утечка Refresh-токена несет серьезный ущерб

Атаки на JWT: влияние
- Сильный контроль над приложением
- Обход аутентификации
- Повышение привилегий внутри приложения
- ATO (account takeover)
- Представление другим пользователем
- Другие векторы атак

Атаки на JWT

отсутствие проверки подписи
- Вместо метода verify() используется decode()
- Подпись не проверяется
- Можно записывать любые данные
Защита:
- Проверять подпись

Поддержка алгоритма none
- Приложение полностью доверяет токену от клиента (Принцип JWT)
- Приложение не ограничивает используемые алгоритмы
- Происходит замена на алгоритм none и подпись "отрезается", оставляя при этом завершаюзую точку
Защита:
- отключение none алгоритма

Перебор ключей HS256
- Алг hs256 - симметричный
- Если используется слабый ключ, его можно эффективно подобрать
- `hashcat -a O -m 16500 <jwt> <wordlost>` (брут)
Защита: использовать надёжные ключи

JWK, JKU, KID
- json web key - формат представления ключа в json формате
- json web key set URL - ссылка, по которой можно полуить множество ключей и выбрать из них необходимы
- key id - id, позволяющий однозначно определить ключ из множества. В некоторых случаях позволяет указать путь до файла с ключом

JWK
1. Приложение использует ассиметричный алгоритм RS256
2. Атакующий генерирует пару ключей
3. Атакующий подписывает JWT собственным приватным ключом, а публичный помещает в токен в jwk
4. Приложение использует ключ из jwk для проверки подписи => доверяет токену
Защита - ...

Использование самоподписанного jku
1. Приложение использует ассиметричный алгоритм RS256
2. Атакующий генерирует пару ключей
3. Атакующий подписывает JWT собственным приватным ключом, а публичный помещает в токен в jwk set на своем сервере
4. Параметр jku указывается ссылка на JWK set, а также изменяется kid

Использование самоподписанного ключа (kid)
1. Приложение использует симметричный алгоритм (HS256)
2. В значение KID можно указать путь до файла
3. Атакующий может подписать токен любым файлом, если знает его содержимое
4. Можно использовать /dev/null и подписать пустым ключом
5. Также, возможна эксплуатация SQLi через этот параметр
Защита: не позволять принимать произвольный путь; защищаться от sqli

algorithm confusion

Идея: смена ассиметричного алгоритма на симметричный. В качестве подписи использовать публичный ключ.
Этапы эксплуатации:
1. Получение публичного ключа:
	1. в публично доступных директориях
	2. вычислить на основе выданных токенов
2. Перевод в необходимый формат (JWK, X.509 PEM, и т.д.) - ключ должен побайтово совпадать с имеющимся на сервере
3. Создание JWT с alg HS256, подпись токена полученным ключом
Защита: 
- проверка соответствия используемому алгоритму

JWT Invalidation
т.к. JWT - Stateless (не имеет состояния на стороне сервера) существуют проблемы в его инвалидации
некоторые способы
- Указание очень короткого TTL
- Черный список невалидных токенов
- Механизмы инвалидации токенов по id
- Смена ключа подписи (радикальный метод)
Защита:
- Проверка ...


