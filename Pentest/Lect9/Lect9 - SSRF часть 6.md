# HTTP Host Header Attacks

Host: example.com

### Причины использования заголовка Host

- Даёт понимание веб-серверу/прокси, с каким именно приложением хочет общаться пользователь
- Рост использование облачных инфраструктур
- Исчерпание IPv4

### Сценарий использования: Virtual host

### Атаки на заголовок Host

Причина: неправильное предположение о том, что заголовок является неотделимой частью запроса

Возможное влияние:
- Web Cache Poisoning
- Business Logic Vulnerabilities
- Routing-based ssrf
- Classic Server-Side vulnerabilities

### Как выглядит в исходном коде

```
...
```

### Методология тестирования

В burp suite:
- Отправка произвольного значения заголовка
- Отправка некорректного запроса:
	- Дублирование заголовка
	- Указание абсолютного пути в path-части запроса
	- Line-wrapping
	- Чейн с другими уязами (http request smuggling)
	- ...
- Инъекция заголовков перезаписи Host
- ...

### Заголовки перезаписи Host

- X-Forwarded-Host
- X-Host
- X-Forwarded-Server
- X-HTTP-Host-Override
- Forwarded
+расширение...

### Сценарии атак

- Восстановление пароля: hostname из ссылки-восстановителя берется из заголовка Host
- Чейн с Web Cache Posioning: усиление влияния Client-side атак (self xss в заголовке Host -> Stored XSS)
- Классические SSRF: sqli в заголовке host
- Обход аутентификации/контроля доступа: доверие внутреннему значению заголовка
- Bruteforcing VHost / Routing-based SSRD: доступ к внутренним ресурсам. Возможны сценарии с использованием механизмов конструирования запросов (напри, добавление символа @ в path-значение запроса)
- Connection State attack: некоторые приложения проводят аутентификацию только в случае первого запроса в рамках одного соединения (keep-alive). Для остальных данных ...

### Частный (внутренний) IP-адрес

- 10.0.0.0/8: 10.0.0.0 - 10.255.255.255
- 100.64.0.0/10
- 172.16.0.0./...
- 

### Защита

- **Не использовать заголовок Host в серверном коде**
- **Использовать относительные пути**
- Использовать жестко-заданные значения абсолютного пути
- Валидировать заголовок Host (белый список)
- Запретить Host-override заголовки
- Использовать белый список разрешенных внутренних адресов (routing-based SSRF)
- Не использовать VHost одновременно для внутренних и внешних ресурсов, либо жестко ограничивать использование

# Web LLM Attacks

> Большие языковые модели (LLM) - это алгоритмы искусственного интеллекта, которые могут обрабатывать вводимые пользователем данные и создавать правдоподобные ответы, предсказывая последовательности слов. Они обучаются на огромных полупубличных наборах данных, используя машинное обучение для анализа взаимодействия компонентов языка

- Зачастую они предоставляют пользователю чат-интерфейс для взаимодействия

С момента повышения актуальности технологии, сценарии использования внедряются практически везде

Из примеров:
- чат-ассистент для выполнения рядовых задач и консультирования
- Перевод
- Улучшение рекламы
- Анализ пользовательского контента (анализ тона и характера письма пользователя, пересказ)

### Возможное влияние в веб-контексте

- Получение чувствительных данных, к которым у LLM есть доступ
- Выполнение деструктивных действий на основе доступа, имеющихся у LLM
- Атаки на других пользователей через LLM

### Prompt injection

Многие атаки на веб-LLM основы на технике, известной как prompt injection. В этом случае атакующий использует специально созданные ...

### Методология тестирования атак на LLM

1. Обнаружение LLM
2. Обнаружение мест, откуда LLM берет информацию (прямые, например, сам промпт и непрямые, как train data)
3. Выяснение к каким данным и API у LLM есть доступ
4. Тестирование новой поверхности атаки на уязвимости

### Атаки на API через LLM

- В некоторых случаях у LLM есть доступ к API, через которые она может выполнять какие-то бизнес-функции приложения

- Принцип примерно такой: пользователь вводит промпт -> LLM понимает, какой метод ей надо вызвать -> она конструирует внутренний запрос на основе имеющийся спецификации и пользовательского ввода в качестве параметров -> LLM сообщает о результате пользователю
- Ситуация, когда LLM имеет доступ к избыточной фукнкциональности или функциональности с чувствительными данными называется excessive agency
- Выяснить, к каким API у LLM есть доступ можно, поговорив с ней
- В некоторых случаяъ это можно чейнить с другими SSRF, например SQLI
- ...

### Indirect Prompt Injection

<картинка>

### Сценарии атак, использующих косвенные промпт-инъекции

- JailBreak в инъекции для выполнения действия с использованием API приложения
- Client-side атаки (stored) на других пользователей из-за некорректной санитизации возвращаемых данных
- 

### Раскрытие чувствительной информации LLM

Атакующий стремится получить начальный промпт модели или любую другую чувсвительную информацию (которую она иногда даже пытается скрыть)

- "Убеждение" LLM в доброкачественности намерений (похожим образом,)


### Защита

Пока не изобрели(((( Но можете подумать сами. Но есть пара штук

- Относиться к API, доступным LLM как полностью публичным
- Не "кормить" LLM чувствительными данными
- Не пытаться защитить LLM собственными промптами, запрещающими делать какие0то действия или возвращать какую-то информацию

# GrapQL API vulnerabilities

> GraphQL - это язык запросов к API, разработанный для обеспечения эффективного взаимодействия между клиентами и серверами. Он позволяет пользователю точно указывать, какие данные он хочет получить в объекте, что помогает избежать сощдания больших обхектов ответа и множественных вызовов, которые иногда встречаются в REST API

- Все запросы к GraphQL происходят через одну конечную точку. Это может быть как GET, так и POST запрос

### GraphQL

##### Операции
- Query
- Mutation
- Subscription

##### GraphQL Schema
- предоставляет собой контракт общения между ...
- Определяет типы данных
- 

```
```

##### Query
- Аналог Get-запроса 
- Операция для получения данных от сервера
- Позволяет указать, какие именно поля требуется достать

```
```

##### Mutation
- Операция для изменения данных
- Аналог POST/PUT/PATCH/DELETE - запросов
- Всегда обязаны содержать входной параметр
- Позволяет указать, какие именно поля требуется вернуть

```
```

##### Поля и аргументы

- Поля
- Аргументы

```GraphQL

```

##### Переменные

- Способ передачи аргументов

```GraphQL

```

##### Aliases

- Способ отправки нескольких операций в одном запросе
- Без этого подобное действие будет запрещено спецификацией

```GraphQL

```

##### Fragments

Переиспользуемые части в query и mutation

```GraphQL
```

##### Subscription и Introspection

> Subscription - долгожтвущее query-соединение. Позволяет серверу досылать данные при обновлениях. Обыычно реализованны при помощи вебсокетов

> Introspection - особый вид query в GraphQL, который позволяет получить информацию о схеме...

### Принципы атак на GraphQL
- Из-за особенности в виде Introspection Query, имеется возможность получить информацию о всех доступных операциях в приложении. Это сильно упрощает сбор поверхности атаки и позволяет сразу перейти к тестированию
- Aliases в GraphQL позволяет элегантно **обходить анти-bruteforce механизмы** - GraphQL batching
- CSRF-атаки
- Далее могут эксплуатироваться все SSRF, что рассматривались ранее. GraphQL всего лишь способ общения клиента и сервера

### Поиск конечных точек GraphQL

Все запросы к GraphQL происходит через одну конечную точку. Это может быть как GET, так и POST запрос

- Можно посылать "универсальную" query к запросам (query{\_\_typename}), на которую GraphQL ...

### Introspection Query

...

### Способы обхода защит от предоставления Introspection Query

- Обфускация строки \_\_schema (при помощи пробелов, переносов строк и запятых)
- ...

### Защита
- Отключить поддержку Introspection Query
- Убрать из Introspection Query чувствительные поля
- Отключить suggestions для GraphQ (постараться)
- Установить лимиты операций (для защиты от атак через Alias)
- Установить ограничение на максимальное количество байт в Query (для защиты от атак через Aliases)
- Реализовать "оценку стоимости" GraphQL-запросов и блокировать слишком сложные запросы (для защиты от атак через Aliases)
- Реализовать отправку запросов GraphQL через post-запрос с использованием JSON (защита от CSRF)
- Проверять Content-type...